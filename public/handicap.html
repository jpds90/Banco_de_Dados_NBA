<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Handicap Estimado</title>
  <script>
    async function calcularHandicap() {
      try {
        // Receber as datas de início e fim
        const startDate = '01.01'; // Exemplo de data de início
        const endDate = '31.12';   // Exemplo de data de fim

        // Buscar as médias de pontos dos times
        const resposta1 = await fetch(`/team-averages?start_date=${startDate}&end_date=${endDate}`);
        const averages = await resposta1.json();

        // Verifique se existem dados
        if (!averages || averages.length === 0) {
          document.getElementById('handicap').textContent = "Nenhum dado encontrado.";
          return;
        }

        // Busque as informações necessárias para o cálculo
        const mediaTimeAEmCasa = averages[0].home_avg || 0;
        const mediaTimeBEmFora = averages[0].away_avg || 0;

        // Agora, buscamos os dados dos últimos jogos
        const resposta2 = await fetch('/ultimosjogos4');
        const jogos = await resposta2.json();

        // Achar os jogos para o time que estamos calculando (vamos assumir o primeiro par de times)
        const jogo = jogos[0]; // Considerando o primeiro par de times, modifique conforme necessário
        const homeWinAvg = parseFloat(jogo.home_last_games.win_avg) || 0;
        const homeLossAvg = parseFloat(jogo.home_last_games.loss_avg) || 0;
        const awayWinAvg = parseFloat(jogo.away_last_games.win_avg) || 0;
        const awayLossAvg = parseFloat(jogo.away_last_games.loss_avg) || 0;

        // Agora, buscamos os dados dos confrontos diretos
        const resposta3 = await fetch(`/gamestats`);
        const gamestats = await resposta3.json();

        // Achar o confronto direto entre os times
        const confrontosDiretos = gamestats.find(confronto => confronto.time_home === averages[0].time_home && confronto.time_away === averages[0].time_away);
        const avgDiffConfrontoDireto = confrontosDiretos ? confrontosDiretos.avg_difference : 0;

        // Cálculo do Handicap Estimado
        const diferencaTimeAEmCasa = homeWinAvg - homeLossAvg;
        const diferencaTimeBEmFora = awayWinAvg - awayLossAvg;
        
        // Buscar a vantagem do confronto direto
        const vantagemConfrontoDireto = parseFloat(avgDiffConfrontoDireto);

        // Cálculo do Handicap Estimado
        const handicap = (mediaTimeAEmCasa - mediaTimeBEmFora) +
                         (diferencaTimeAEmCasa - diferencaTimeBEmFora) +
                         vantagemConfrontoDireto;

        // Exibir o resultado
        document.getElementById('handicap').textContent = `Handicap Estimado: ${handicap.toFixed(2)}`;

        // Exibir os dados usados para o cálculo
        document.getElementById('dados').innerHTML = `
          <p>Média de pontos Time A em casa: ${mediaTimeAEmCasa}</p>
          <p>Média de pontos Time B fora: ${mediaTimeBEmFora}</p>
          <p>Diferença de pontos Time A em casa: ${diferencaTimeAEmCasa.toFixed(2)}</p>
          <p>Diferença de pontos Time B fora: ${diferencaTimeBEmFora.toFixed(2)}</p>
          <p>Vantagem do confronto direto: ${vantagemConfrontoDireto}</p>
        `;
        
      } catch (error) {
        console.error("Erro ao calcular o handicap:", error);
        document.getElementById('handicap').textContent = "Erro ao calcular o Handicap.";
      }
    }

    // Chama a função de calcular o Handicap ao carregar a página
    window.onload = calcularHandicap;
  </script>
</head>
<body>
  <h1>Handicap Estimado</h1>

  <div id="dados">
    <!-- Aqui serão exibidos os dados necessários para o cálculo -->
  </div>

  <h2 id="handicap"></h2>
  
</body>
</html>
