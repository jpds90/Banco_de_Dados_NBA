<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pa√≠ses e Ligas</title>
    <style>
        .country {
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .leagues {
            display: none;
            margin-left: 20px;
        }
        .league {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
            margin-top: 5px;
        }
        .loading {
            color: gray !important; /* Cor cinza ao carregar */
        }
        .success {
            color: green !important; /* Cor verde ao finalizar */
        }
    </style>
</head>
<body>
    <h1>Selecione um Pa√≠s</h1>
    <div id="countries"></div>
    
    <script>
        function formatText(text) {
            return text
                .normalize("NFD") // Remove acentos
                .replace(/[\u0300-\u036f]/g, "") // Remove caracteres diacr√≠ticos
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "-") // Substitui espa√ßos e caracteres inv√°lidos por "-"
                .replace(/^-+|-+$/g, ""); // Remove "-" extras no come√ßo e no final
        }

        const countries = {
            "Brasil": ["S√©rie A", "S√©rie B", "S√©rie C", "S√©rie D", "paulista", "carioca"],
            "Portugal": ["Primeira Liga", "Segunda Liga"],
            "Espanha": ["LaLiga", "Ta√ßa do Rei de Espanha"],
        };

        const countryContainer = document.getElementById("countries");

        for (let country in countries) {
            let countryElement = document.createElement("div");
            countryElement.classList.add("country");
            countryElement.textContent = country;
            countryContainer.appendChild(countryElement);
            
            let leaguesDiv = document.createElement("div");
            leaguesDiv.classList.add("leagues");
            
            countries[country].forEach(league => {
                let leagueElement = document.createElement("div");
                leagueElement.textContent = league;
                leagueElement.classList.add("league");

                leagueElement.addEventListener("click", async (event) => {
                    event.stopPropagation(); // Impede que o clique no pa√≠s feche a lista

                    let formattedCountry = formatText(country);
                    let formattedLeague = formatText(league);
                    let url = `https://www.flashscore.pt/futebol/${formattedCountry}/${formattedLeague}/lista/`;

                    // üîπ Muda a cor da liga para indicar carregamento
                    leagueElement.classList.add("loading");

                    // üîπ Exibe mensagem de carregamento
                    alert(`‚è≥ Processando liga ${league}... Aguarde!`);

                    try {
                        // üîπ 1. Enviar a URL para o servidor
                        const response = await fetch("https://analise-jpnba.onrender.com/salvar-url", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ url })
                        });

                        const result = await response.json();
                        console.log("‚úÖ URL enviada:", result.message);

                        if (result.success) {
                            // üîπ 2. Executar `futebollink`
                            const executeScriptResponse = await fetch("https://analise-jpnba.onrender.com/futebollink", {
                                method: "POST"
                            });

                            const executeResult = await executeScriptResponse.text();
                            console.log("‚öΩ Script futebollink executado:", executeResult);

                            // üîπ 3. Executar `oddsfutebol`
                            const executeOddsResponse = await fetch("https://analise-jpnba.onrender.com/oddsfutebol", {
                                method: "POST"
                            });

                            const executeOddsResult = await executeOddsResponse.text();
                            console.log("üé≤ Script oddsfutebol executado:", executeOddsResult);

                            // ‚úÖ Muda a cor da liga para verde ap√≥s sucesso
                            leagueElement.classList.remove("loading");
                            leagueElement.classList.add("success");

                            // ‚úÖ Exibe alerta de sucesso
                            alert(`‚úÖ Liga ${league} processada com sucesso!\nURL: ${url}`);
                        } else {
                            throw new Error("Erro ao salvar a URL.");
                        }
                    } catch (error) {
                        console.error("‚ùå Erro:", error);
                        alert("‚ùå Ocorreu um erro ao processar a liga. Tente novamente.");
                        leagueElement.classList.remove("loading"); // Remove cor de carregamento se falhar
                    }
                });

                leaguesDiv.appendChild(leagueElement);
            });

            countryElement.addEventListener("click", () => {
                leaguesDiv.style.display = leaguesDiv.style.display === "block" ? "none" : "block";
            });

            countryContainer.appendChild(leaguesDiv);
        }
    </script>
</body>
</html>
