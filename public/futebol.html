<!DOCTYPE html>
<html lang="pt">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Casa de Apostas Esportivas</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
   <style>
      body {
         font-family: 'Roboto', sans-serif;
         background-color: #1e1e1e;
         color: #f1f1f1;
         text-align: center;
         padding: 20px;
      }
      select, button {
         padding: 10px;
         font-size: 16px;
         margin: 10px;
      }
      .matches {
         margin-top: 20px;
      }
      .match {
         padding: 10px;
         background-color: #333;
         border-radius: 5px;
         margin: 5px 0;
      }
   </style>
</head>
<body>
   <h1>Casa de Apostas Esportivas</h1>
   
   <select id="countrySelect">
      <option value="">Escolha um país</option>
   </select>
   
   <select id="leagueSelect" style="display: none;"></select>
   
   <button id="fetchGames" style="display: none;">Buscar Jogos</button>
   
   <div class="matches" id="matches"></div>
      <!-- Tabela de Médias de Gols -->
   <table>
      <thead>
         <tr>
            <th>Casa</th>
            <th>Visitante</th>
            <th>Média de Gols (Casa)</th>
            <th>Média de Gols (Fora)</th>
            <th>Média de Gols(Total)</th>
         </tr>
      </thead>
      <tbody id="averagesTable"></tbody>
   </table>

   <!-- Segunda Linha de Tabelas Lado a Lado -->
   <div class="side-by-side">
      <table>
         <thead>
            <tr>
               <th>Casa</th>
               <th>Visitante</th>
               <th>Média Confronto (Casa)</th>
               <th>Média Confronto (Visitante)</th>
               <th>Total de Gol</th>
            </tr>
         </thead>
         <tbody id="headToHeadTable"></tbody>
      </table>
   </div>

   <script>
      const countries = {
         "Brasil": ["Série A", "Série B", "Série C"],
         "Portugal": ["Primeira Liga", "Segunda Liga"],
         "Espanha": ["LaLiga", "Taça do Rei de Espanha"]
      };

      const countrySelect = document.getElementById("countrySelect");
      const leagueSelect = document.getElementById("leagueSelect");
      const fetchGamesButton = document.getElementById("fetchGames");
      const matchesDiv = document.getElementById("matches");

      // Preencher dropdown de países
      for (let country in countries) {
         let option = document.createElement("option");
         option.value = country;
         option.textContent = country;
         countrySelect.appendChild(option);
      }

      countrySelect.addEventListener("change", function() {
         leagueSelect.innerHTML = "<option value=''>Escolha uma liga</option>";
         leagueSelect.style.display = "none";
         fetchGamesButton.style.display = "none";
         matchesDiv.innerHTML = "";
         
         if (this.value) {
            countries[this.value].forEach(league => {
               let option = document.createElement("option");
               option.value = league;
               option.textContent = league;
               leagueSelect.appendChild(option);
            });
            leagueSelect.style.display = "block";
         }
      });

      leagueSelect.addEventListener("change", function() {
         fetchGamesButton.style.display = this.value ? "block" : "none";
      });

fetchGamesButton.addEventListener("click", async function() {
   const selectedLeague = leagueSelect.value;
   if (!selectedLeague) return;

   let tableName = selectedLeague.replace(/\s+/g, "_").toLowerCase() + "_odds";
   console.log(`Buscando dados para a tabela: ${tableName}`);

   matchesDiv.innerHTML = "Carregando...";

   try {
      // A consulta será realizada agora com base na tabela correspondente à liga
      const response = await fetch(`https://analise-jpnba.onrender.com/buscar-jogos?tableName=${tableName}`);
      const result = await response.json();

      matchesDiv.innerHTML = "";

      if (result.success && result.data.length > 0) {
         result.data.forEach(match => {
            let matchElement = document.createElement("div");
            matchElement.classList.add("match");
            matchElement.textContent = `${match.time_home} x ${match.time_away}`;
            matchesDiv.appendChild(matchElement);

            // Formatar os nomes dos times para incluir _futebol e garantir que tudo esteja em minúsculas
            const homeTeam = match.time_home.toLowerCase().replace(/\s/g, '_') + "_futebol";
            const awayTeam = match.time_away.toLowerCase().replace(/\s/g, '_') + "_futebol";

            // Chamar o back-end para calcular a média de gols com base na tabela da liga
            fetch(`/calcular-media-gols?tableName=${tableName}&home=${homeTeam}&away=${awayTeam}`)
               .then(response => response.json())
               .then(data => {
                  if (data.success) {
                     let averageRow = document.createElement("tr");
                     averageRow.innerHTML = `
                        <td>${match.time_home}</td>
                        <td>${match.time_away}</td>
                        <td>${data.mediaGolsCasa}</td>
                        <td>${data.mediaGolsFora}</td>
                        <td>${data.mediaGolsTotal}</td>
                     `;
                     averagesTable.appendChild(averageRow);
                  }
               })
               .catch(error => console.error("Erro ao calcular as médias de gols", error));
         });
      } else {
         matchesDiv.innerHTML = "<p>Nenhum jogo encontrado.</p>";
      }
   } catch (error) {
      console.error("Erro ao buscar os jogos:", error);
      matchesDiv.innerHTML = "<p>Erro ao buscar os jogos. Tente novamente.</p>";
   }
});

   </script>
</body>
</html>
