<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas de Futebol</title>
</head>
<body>
    <h2>Filtrar por País e Liga</h2>
    <label for="countrySelect">Escolha o País:</label>
    <select id="countrySelect" onchange="loadLeagues()">
        <option value="">Selecione...</option>
    </select>

    <label for="leagueSelect">Escolha a Liga:</label>
    <select id="leagueSelect">
        <option value="">Selecione...</option>
    </select>

    <button onclick="fetchGoalAverages()">Buscar Jogos</button>

    <h2>Comparação de Confrontos</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Casa</th>
                <th>Visitante</th>
                <th>Média de Gols (Casa)</th>
                <th>Média de Gols (Fora)</th>
                <th>Média Total</th>
            </tr>
        </thead>
        <tbody id="headToHeadTable"></tbody>
    </table>

    <h2>Média de Gols e Contagem de Partidas</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Casa</th>
                <th>Visitante</th>
                <th>Média de Gols (Casa)</th>
                <th>Qtd. Jogos > Gols (Casa)</th>
                <th>Média de Gols (Fora)</th>
                <th>Qtd. Jogos > Gols (Fora)</th>
                <th>Média Total</th>
                <th>Filtrar por Gols:</th>
            </tr>
        </thead>
        <tbody id="goalAveragesTable"></tbody>
    </table>

    <script>
        async function loadCountries() {
            try {
                const response = await fetch("https://analise-jpnba.onrender.com/countries");
                const countries = await response.json();
                const countrySelect = document.getElementById("countrySelect");

                countries.forEach(country => {
                    const option = document.createElement("option");
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar países:", error);
            }
        }

        async function loadLeagues() {
            const country = document.getElementById("countrySelect").value;
            const leagueSelect = document.getElementById("leagueSelect");
            leagueSelect.innerHTML = "<option value=''>Selecione...</option>";

            if (!country) return;

            try {
                const response = await fetch(`https://analise-jpnba.onrender.com/leagues?country=${country}`);
                const leagues = await response.json();

                leagues.forEach(league => {
                    const option = document.createElement("option");
                    option.value = league;
                    option.textContent = league;
                    leagueSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar ligas:", error);
            }
        }

        async function fetchGoalAverages() {
            const country = document.getElementById("countrySelect").value;
            const league = document.getElementById("leagueSelect").value;
            if (!country || !league) {
                alert("Selecione um País e uma Liga!");
                return;
            }

            try {
                const response = await fetch(`https://analise-jpnba.onrender.com/golsemcasa?country=${country}&league=${league}`);
                const data = await response.json();

                const tableBody = document.getElementById("goalAveragesTable");
                tableBody.innerHTML = "";

                data.forEach(match => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${match.time_home}</td>
                        <td>${match.time_away}</td>
                        <td>${match.home_avg}</td>
                        <td id="home-count-${match.time_home}">--</td>
                        <td>${match.away_avg}</td>
                        <td id="away-count-${match.time_away}">--</td>
                        <td>${match.total_pontos}</td>
                        <td>
                            <input type="number" min="0" max="10" id="input-${match.time_home}" 
                                onchange="updateGoalCount('${match.time_home}', '${match.time_away}', this.value, ${JSON.stringify(match.home_goal_counts)}, ${JSON.stringify(match.away_goal_counts)})">
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Erro ao buscar as médias de gols:", error);
            }
        }

        function updateGoalCount(homeTeam, awayTeam, value, homeGoalCounts, awayGoalCounts) {
            const goalThreshold = parseFloat(value);
            if (isNaN(goalThreshold)) return;

            const homeCount = homeGoalCounts.filter(g => g >= goalThreshold).length;
            const awayCount = awayGoalCounts.filter(g => g >= goalThreshold).length;

            document.getElementById(`home-count-${homeTeam}`).innerText = homeCount;
            document.getElementById(`away-count-${awayTeam}`).innerText = awayCount;
        }

        loadCountries();
    </script>
</body>
</html>
