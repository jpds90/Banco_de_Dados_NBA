<!DOCTYPE html>
<html lang="pt">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Casa de Apostas Esportivas</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
   <style>
      body {
         font-family: 'Roboto', sans-serif;
         background-color: #1e1e1e;
         color: #f1f1f1;
         text-align: center;
         padding: 20px;
      }
      select, button, input {
         padding: 10px;
         font-size: 16px;
         margin: 10px;
      }
      .matches {
         margin-top: 20px;
      }
      .match {
         padding: 10px;
         background-color: #333;
         border-radius: 5px;
         margin: 5px 0;
      }
      table {
         width: 100%;
         margin-top: 30px;
         border-collapse: collapse;
      }
      th, td {
         padding: 10px;
         border: 1px solid #444;
      }
      th {
         background-color: #555;
      }
      .side-by-side {
         display: flex;
         justify-content: space-between;
      }
   </style>
</head>
<body>
   <h1>Casa de Apostas Esportivas</h1>
   
   <select id="countrySelect">
      <option value="">Escolha um país</option>
   </select>
   
   <select id="leagueSelect" style="display: none;"></select>
   
   <button id="fetchGames" style="display: none;">Buscar Jogos</button>
   
   <div class="matches" id="matches"></div>

   <!-- Tabela de Médias -->
   <table>
      <thead>
         <tr>
            <th>Casa</th>
            <th>Visitante</th>
            <th>Média Gols (Casa)</th>
            <th>Média Gols (Fora)</th>
            <th>Total de Gol</th>
         </tr>
      </thead>
      <tbody id="averagesTable"></tbody>
   </table>

   <!-- Segunda Linha de Tabelas Lado a Lado -->
   <div class="side-by-side">
      <table>
         <thead>
            <tr>
               <th>Casa</th>
               <th>Visitante</th>
               <th>Média Confronto (Casa)</th>
               <th>Média Confronto (Visitante)</th>
               <th>Total de Gol</th>
            </tr>
         </thead>
         <tbody id="headToHeadTable"></tbody>
      </table>
   </div>
   
   <!-- Filtro de Gols -->
   <div>
      <label for="goalThreshold">Digite um valor de gol:</label>
      <input type="number" id="goalThreshold" placeholder="Ex: 0.5" step="0.1">
   </div>

   <!-- Resultados do Filtro de Gols -->
   <div id="goalResults" style="margin-top: 20px;"></div>
   
   <script>
      const countries = {
         "Brasil": ["Série A", "Série B", "Série C"],
         "Portugal": ["Primeira Liga", "Segunda Liga"],
         "Espanha": ["LaLiga", "Taça do Rei de Espanha"]
      };

      const countrySelect = document.getElementById("countrySelect");
      const leagueSelect = document.getElementById("leagueSelect");
      const fetchGamesButton = document.getElementById("fetchGames");
      const matchesDiv = document.getElementById("matches");
      const averagesTable = document.getElementById("averagesTable");
      const headToHeadTable = document.getElementById("headToHeadTable");
      const goalThresholdInput = document.getElementById("goalThreshold");
      const goalResultsDiv = document.getElementById("goalResults");

      // Preencher dropdown de países
      for (let country in countries) {
         let option = document.createElement("option");
         option.value = country;
         option.textContent = country;
         countrySelect.appendChild(option);
      }

      countrySelect.addEventListener("change", function() {
         leagueSelect.innerHTML = "<option value=''>Escolha uma liga</option>";
         leagueSelect.style.display = "none";
         fetchGamesButton.style.display = "none";
         matchesDiv.innerHTML = "";
         
         if (this.value) {
            countries[this.value].forEach(league => {
               let option = document.createElement("option");
               option.value = league;
               option.textContent = league;
               leagueSelect.appendChild(option);
            });
            leagueSelect.style.display = "block";
         }
      });

      leagueSelect.addEventListener("change", function() {
         fetchGamesButton.style.display = this.value ? "block" : "none";
      });

      fetchGamesButton.addEventListener("click", async function() {
         const selectedLeague = leagueSelect.value;
         if (!selectedLeague) return;
         
         let tableName = selectedLeague.replace(/\s+/g, "_").toLowerCase() + "_odds";
         console.log(`Buscando dados para a tabela: ${tableName}`);
         
         matchesDiv.innerHTML = "Carregando...";
         
         try {
            const response = await fetch(`https://analise-jpnba.onrender.com/buscar-times?tableName=${tableName}`);
            const result = await response.json();
            
            matchesDiv.innerHTML = "";
            
            if (result.success && result.data.length > 0) {
               result.data.forEach(match => {
                  let matchElement = document.createElement("div");
                  matchElement.classList.add("match");
                  matchElement.textContent = `${match.data_jogo} - ${match.time_home} x ${match.time_away}`;
                  matchesDiv.appendChild(matchElement);
               });
            } else {
               matchesDiv.innerHTML = "<p>Nenhum jogo encontrado.</p>";
            }
         } catch (error) {
            console.error("Erro ao buscar os jogos:", error);
            matchesDiv.innerHTML = "<p>Erro ao buscar os jogos. Tente novamente.</p>";
         }

         // Preencher as tabelas de médias e confrontos diretos
         try {
            const averagesResponse = await fetch(`https://analise-jpnba.onrender.com/confrontosfutebol?tableName=${tableName}`);
            const averagesData = await averagesResponse.json();
            
            averagesTable.innerHTML = "";
            headToHeadTable.innerHTML = "";

            averagesData.forEach(item => {
               // Exibir as médias de gols feitos em casa e como visitante
               let headToHeadRow = document.createElement("tr");
               headToHeadRow.innerHTML = `
                  <td>${item.time_home}</td>
                  <td>${item.time_away}</td>
                  <td>${item.home_avg}</td>
                  <td>${item.away_avg}</td>
                  <td>${item.total_pontos}</td>
               `;
               headToHeadTable.appendChild(headToHeadRow);
            });
         } catch (error) {
            console.error('Erro ao buscar dados de confrontos:', error);
         }
      });

      // Função para buscar dados com filtro de gols
      async function fetchGoalData() {
         const threshold = parseFloat(goalThresholdInput.value);
         if (isNaN(threshold) || threshold <= 0) {
            goalResultsDiv.innerHTML = "<p>Por favor, insira um valor válido para o gol.</p>";
            return;
         }

         const selectedLeague = leagueSelect.value;
         if (!selectedLeague) return;

         let tableName = selectedLeague.replace(/\s+/g, "_").toLowerCase() + "_odds";
         try {
            const response = await fetch(`https://analise-jpnba.onrender.com/golsemcasa?tableName=${tableName}&threshold=${threshold}`);
            const result = await response.json();

            goalResultsDiv.innerHTML = ""; // Limpar resultados anteriores

            if (result.length > 0) {
               result.forEach(item => {
                  const homeGoals = item.home_hits_threshold ? `Acima de ${threshold}: ${item.home_hits_threshold} vezes` : `Não atingiu`;
                  const awayGoals = item.away_hits_threshold ? `Acima de ${threshold}: ${item.away_hits_threshold} vezes` : `Não atingiu`;

                  let resultElement = document.createElement("div");
                  resultElement.innerHTML = `
                     <strong>${item.time_home} x ${item.time_away}</strong><br>
                     Casa: ${homeGoals}<br>
                     Visitante: ${awayGoals}<br><br>
                  `;
                  goalResultsDiv.appendChild(resultElement);
               });
            } else {
               goalResultsDiv.innerHTML = "<p>Nenhum dado encontrado.</p>";
            }
         } catch (error) {
            console.error('Erro ao buscar dados de gols:', error);
            goalResultsDiv.innerHTML = "<p>Erro ao buscar os dados. Tente novamente.</p>";
         }
      }

      // Adicionar evento para quando o usuário digitar o valor de gol
      goalThresholdInput.addEventListener("input", fetchGoalData);
   </script>
</body>
</html>
